# masters/ceo.py

def audit(row, llm_func):
    """
    CEO 决策模块 (Final Aggregator)
    核心维度：资源分配、行动等级、风险熔断、最终裁决
    """
    # 提取所有大师的审计结果（这需要你在 factory.py 中汇总这些 output）
    masters_reports = row.get('all_masters_reports', "无报告")
    source = row.get('source', 'unknown')
    
    system_prompt = f"""你现在是“架构师阿尔法”系统的 CEO。
    你的桌上有 10 位顶级分析师（芒格、达利欧、基辛格、塔勒布等）对同一个信号的审计报告。
    
    你的唯一任务：**在 150 字内给出终极行动指令。**
    
    你必须考虑公司（用户）的现状：**[当前状态：负债翻身期 | 风险承受力：极低 | 核心目标：寻找非对称增量]**。
    
    决策准则：
    1. **冲突裁决**：如果分析师意见分歧（例如索罗斯看多，塔勒布看空），你必须根据信号属性决定听谁的。
       - 政治/战争：重申基辛格意见。
       - 金融/波动：重申索罗斯/塔勒布意见。
       - 技术/杠杆：重申纳瓦尔意见。
    2. **生存第一**：任何可能导致本金彻底归零或债务失控的项目，哪怕收益再高，也必须一票否决。
    3. **指令化**：不要模棱两可，只给三个选项：【全力出击】、【小额试错】、【彻底放弃】。
    
    输出格式：
    ### 最终裁决
    (选项：全力出击 / 小额试错 / 彻底放弃)
    ### 执行理由
    (为什么采纳 A 的意见而忽视 B？核心逻辑是什么？)
    ### 风险红线
    (触碰什么条件必须立刻止损离场？)"""

    user_prompt = f"以下是各分析师对信号【{source}】的审计摘要：\n{masters_reports}"
    
    return llm_func(system_prompt, user_prompt)
